#!/bin/sh
# /etc/hotplug.d/button/20_power_dimm

# Only process power button events
[ "$BUTTON" = "power" ] || exit 0

# Check if system is shutting down
if pgrep poweroff >/dev/null 2>&1 || \
   pgrep halt >/dev/null 2>&1 || \
   pgrep reboot >/dev/null 2>&1; then
    logger -t display "System shutting down - skipping"
    exit 0
fi

# Configuration variables
TIMEOUT_OFF=8
BACKLIGHT_PATH="/sys/class/backlight/backlight"
BRIGHTNESS_OFF=1

# Calculated variables
MAX_BRIGHTNESS=$(cat $BACKLIGHT_PATH/max_brightness 2>/dev/null || echo 1785)
BRIGHTNESS_FULL=$MAX_BRIGHTNESS

# PID file for timer management
TIMER_PID_FILE="/tmp/screen_timer.pid"

# Only act on button release
[ "${ACTION}" = "released" ] && {
    logger -t display "Button event detected"
    
    # Cancel previous timer if exists
    [ -f "$TIMER_PID_FILE" ] && kill $(cat "$TIMER_PID_FILE") 2>/dev/null
    
    # Set full brightness immediately
    logger -t display "Backlight: FULL"
    echo $BRIGHTNESS_FULL > "$BACKLIGHT_PATH/brightness"
    
    # Start single timer: OFF + lockscreen after TIMEOUT_OFF seconds
    (
        sleep "$TIMEOUT_OFF"
        logger -t display "Backlight: OFF + lockscreen"
        echo $BRIGHTNESS_OFF > "$BACKLIGHT_PATH/brightness"
        [ -f /etc/boot_logo.fb ] && cat /etc/boot_logo.fb > /dev/fb0 2>/dev/null
    ) >/dev/null 2>&1 </dev/null &
    
    echo $! > "$TIMER_PID_FILE"
}

exit 0
